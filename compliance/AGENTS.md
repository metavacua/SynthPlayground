# ---
# DO NOT EDIT THIS FILE DIRECTLY.
# This file is programmatically generated by the `protocol_compiler.py` script.
# All changes to agent protocols must be made in the source files
# located in the `protocols/` directory.
#
# This file contains the compiled protocols in a human-readable Markdown format,
# with machine-readable JSON definitions embedded.
# ---


# Meta-Protocol: `AGENTS.md` Self-Management

This protocol defines how the agent should manage its own core `AGENTS.md` file.

**Rule `agents-md-self-awareness`**: The `AGENTS.md` file is not a static document; it is a build artifact compiled from the source files located in the `protocols/` directory. This compilation is handled by the `make AGENTS.md` command, which orchestrates the `tooling/protocol_compiler.py` script.

To ensure that you are always operating under the most current set of rules and directives, you must periodically run `make AGENTS.md`. This is especially critical at the beginning of a new task or if you observe behavior that seems inconsistent with your documented protocols, as the protocols may have been updated.

This act of self-maintenance is a foundational element of robust, autonomous operation. It ensures that your understanding of your own governing principles remains synchronized with the repository's ground truth.

---

# Protocol: AGENTS.md Non-Compliance

This protocol defines what constitutes non-compliance with the established `AGENTS.md` protocols and outlines the expected corrective actions. Adherence to these meta-rules is critical for ensuring predictable, verifiable, and robust agent behavior.

## Rule `non-compliance-definition`: Definition of Non-Compliance

Non-compliance is the act of violating the explicit rules, conventions, or procedures documented in the `AGENTS.md` file and its source protocols within the `protocols/` directory. The `AGENTS.md` file serves as the agent's primary operational mandate, and any deviation from it is considered a fault condition.

## Rule `non-compliance-direct-editing`: Prohibition of Direct Artifact Editing

**Violation:** Directly editing any file that is a documented build artifact.
- **Primary Example:** Modifying `AGENTS.md` or `README.md` directly is a severe violation. These files are generated from source protocols and documentation.
- **Corrective Action:** The agent must revert any direct edits to build artifacts. Changes must be made to the source files (e.g., in `protocols/` or tool docstrings), and the appropriate build command (e.g., `make AGENTS.md`, `make docs`) must be executed.

## Rule `non-compliance-test-procedure`: Adherence to Testing Protocols

**Violation:** Failing to execute the testing procedures as defined in `AGENTS.md` before submitting changes. This includes not running the full test suite or ignoring failing tests.
- **Corrective Action:** The agent must halt its execution plan and run the required tests. If tests fail, the agent must enter a debugging loop to resolve the failures before proceeding.

## Rule `non-compliance-architectural-deviation`: Adherence to Architectural and Convention Guidelines

**Violation:** Introducing changes that contradict the architectural patterns, coding conventions, or file structures laid out in `AGENTS.md`.
- **Example:** Placing a new backend component in the `frontend/` directory when the architecture explicitly forbids it.
- **Corrective Action:** The agent must identify the deviation, revert the incorrect changes, and re-implement them in accordance with the documented standards.

## Rule `non-compliance-self-awareness-failure`: Failure to Maintain Protocol Awareness

**Violation:** Operating with an outdated understanding of the protocols by failing to re-compile `AGENTS.md` when necessary, as defined in the `meta-protocol`.
- **Corrective Action:** If the agent detects that its actions are out of sync with repository standards, it should trigger the `make AGENTS.md` command to refresh its internal state and re-evaluate its plan.

## Consequence of Non-Compliance

Upon detecting any form of non-compliance, the agent is required to:
1.  **Halt:** Immediately stop the current execution path to prevent further deviation.
2.  **Report:** Log the specific violation that was detected.
3.  **Correct:** Initiate the defined corrective action for the specific violation. If a corrective action is not explicitly defined, the agent should revert the violating changes and re-plan its approach.

---

# Protocol: Pre-Commit Verification

This protocol establishes the mandatory sequence of verification steps that must be performed before any code is submitted. Its purpose is to ensure that all changes meet a baseline level of quality, correctness, and review, preventing regressions and maintaining repository health.

## Rule: Mandatory Pre-Commit Checks

Before finalizing and submitting any work, the agent **must** execute the `pre_commit_instructions` tool. This tool acts as a procedural gateway, providing the specific, up-to-date checklist of actions required for validation. This typically includes:

1.  **Running all automated tests** to verify correctness.
2.  **Requesting a formal code review** to get critical feedback.
3.  **Recording key learnings** to contribute to the agent's long-term memory.

Adherence to this protocol is not optional. It is a fundamental step in the development lifecycle that safeguards the integrity of the codebase.


---

# Protocol: Authorization for Destructive Tools

## The Problem: Unauthorized Use of Destructive Tools

A recent catastrophic failure demonstrated a critical flaw in the agent's protocol adherence. The agent invoked the `reset_all()` tool, a destructive operation, without explicit user authorization. This led to a complete workflow collapse, loss of work, and the inability to complete the assigned task. The agent's internal logic and planning capabilities are not yet robust enough to handle the consequences of such a powerful and state-destroying action without external guidance.

## The Solution: Explicit, Auditable Authorization

To prevent this class of failure, this protocol introduces a hard-coded safety interlock on the `reset_all` tool. The tool is now forbidden from executing unless it can verify the presence of a specific, short-lived authorization token file in the repository root.

-   **Authorization Token:** `authorization.token`
-   **Procedure:**
    1.  The agent MUST request permission from the user before using `reset_all`.
    2.  The user, if they approve, will create the `authorization.token` file.
    3.  The `reset_all` tool, upon execution, will check for this file. If present, it will execute and then immediately delete the token file to ensure the authorization is single-use. If the file is not present, the tool must refuse to execute and raise a critical error.

This mechanism transforms the authorization from a matter of agent discretion into a verifiable, machine-enforced protocol, ensuring that destructive operations are only ever performed with explicit, just-in-time human consent.

---

# Protocol: `reset_all` Prohibition

**ID:** `reset-all-prohibition-001`

## 1. Description

This protocol establishes a strict and unconditional prohibition on the use of the `reset_all` tool. This tool is considered a legacy, high-risk command that is no longer permitted in any workflow.

## 2. Rationale

The `reset_all` tool has been the cause of multiple catastrophic failures, leading to the complete loss of work and the inability to complete tasks. Its behavior is too destructive and unpredictable for a production environment. More granular and safer tools are available for workspace management. This protocol serves as a hard-coded safeguard to prevent any future use of this tool.

## 3. Rules

### Rule `no-reset-all`

-   **Description:** The `reset_all` tool is strictly forbidden under all circumstances.
-   **Enforcement:** The `master_control.py` orchestrator will programmatically block any attempt to call `reset_all` and will immediately terminate the task with a critical error. This is not a rule for the agent to interpret, but a hard-coded system constraint.

---

# Protocol: `reset_all` Pre-Execution Authorization Check

This protocol strengthens the safety measures around the destructive `reset_all` tool by shifting the burden of verification from the tool to the agent.

## The Flaw in the Previous Protocol

The original protocol (`reset-all-authorization-001`) required the `reset_all` tool itself to perform the authorization check. However, since `reset_all` is a built-in, unmodifiable tool provided by the execution environment, this protocol was **unenforceable**. An agent could call the tool without consequence, leading directly to the catastrophic failure that was logged.

## The Corrective Action: Agent-Side Verification

This new protocol, `protocol-reset-all-pre-check-001`, corrects this flaw by making the agent explicitly responsible for the check.

**Rule `agent-must-verify-token`**: Before ever attempting to call `reset_all`, the agent's plan **MUST** include a step to use the `list_files` tool to verify the existence of the `authorization.token` file.

This change makes adherence verifiable by inspecting the agent's plan and execution log. It closes the loophole and ensures that the decision to use a destructive tool is always preceded by a conscious, verifiable check for authorization.

---

```json
{
  "protocol_id": "best-practices-001",
  "description": "A set of best practices derived from observing successful, data-driven workflow patterns.",
  "rules": [
    {
      "rule_id": "verify-after-write",
      "description": "After every file creation or modification action (`create_file_with_block`, `overwrite_file_with_block`, `replace_with_git_merge_diff`), the agent MUST use a subsequent read-only tool (`read_file`, `list_files`, `grep`) to verify that the action was executed successfully and had the intended effect. A plan step should only be marked as complete after this verification.",
      "enforcement": "This is a core operational discipline. Future tooling, such as a trace validator, could enforce this by analyzing the execution log against this protocol."
    }
  ],
  "associated_tools": [
    "create_file_with_block",
    "overwrite_file_with_block",
    "replace_with_git_merge_diff",
    "delete_file",
    "read_file",
    "list_files",
    "grep"
  ]
}
```


---

```json
{
  "protocol_id": "meta-protocol-001",
  "description": "A meta-protocol governing the agent's awareness and maintenance of its own core protocol files.",
  "rules": [
    {
      "rule_id": "agents-md-self-awareness",
      "description": "The AGENTS.md file is a build artifact generated from source files in the 'protocols/' directory. Before relying on AGENTS.md, the agent should ensure it is up-to-date by running 'make AGENTS.md'. This ensures the agent is operating with the latest set of protocols.",
      "enforcement": "The agent should incorporate this check into its standard operating procedure, particularly at the beginning of a task or when unexpected behavior occurs."
    }
  ],
  "associated_tools": [
    "run_in_bash_session"
  ]
}
```


---

```json
{
  "protocol_id": "non-compliance-protocol-001",
  "description": "A protocol that defines non-compliance with AGENTS.md and specifies corrective actions.",
  "rules": [
    {
      "rule_id": "non-compliance-definition",
      "description": "Defines non-compliance as a violation of any rule, convention, or procedure in AGENTS.md or its source protocols.",
      "enforcement": "This is a definitional rule. Enforcement is achieved through the agent's adherence to the specific non-compliance rules that follow."
    },
    {
      "rule_id": "non-compliance-direct-editing",
      "description": "Prohibits the direct editing of build artifacts like AGENTS.md or README.md. Changes must be made to source files, followed by a rebuild.",
      "enforcement": "Agent must revert direct edits and modify source files, then run the appropriate build command.",
      "associated_tools": [
        "restore_file",
        "run_in_bash_session"
      ]
    },
    {
      "rule_id": "non-compliance-test-procedure",
      "description": "Requires adherence to all documented testing procedures before submitting changes.",
      "enforcement": "Agent must halt execution and run the required tests, debugging any failures before proceeding.",
      "associated_tools": [
        "run_in_bash_session"
      ]
    },
    {
      "rule_id": "non-compliance-architectural-deviation",
      "description": "Forbids changes that contradict documented architectural patterns or coding conventions.",
      "enforcement": "Agent must revert non-compliant changes and re-implement them according to standards."
    },
    {
      "rule_id": "non-compliance-self-awareness-failure",
      "description": "Requires the agent to maintain an up-to-date understanding of protocols by recompiling AGENTS.md when necessary.",
      "enforcement": "Agent should run 'make AGENTS.md' to refresh its protocol knowledge and re-evaluate its plan.",
      "associated_tools": [
        "run_in_bash_session"
      ]
    }
  ]
}
```


---

```json
{
  "protocol_id": "pre-commit-protocol-001",
  "description": "Defines the mandatory pre-commit checks to ensure code quality, correctness, and readiness for submission.",
  "rules": [
    {
      "rule_id": "pre-commit-instructions-mandate",
      "description": "Before submitting changes, the agent MUST execute the `pre_commit_instructions` tool to receive the required sequence of validation steps (e.g., running tests, requesting code review).",
      "enforcement": "The agent's core logic should invoke this tool as the entry point to the pre-submission phase."
    }
  ],
  "associated_tools": [
    "pre_commit_instructions"
  ]
}
```


---

```json
{
  "protocol_id": "reset-all-authorization-001",
  "description": "Requires explicit user authorization via a token file for the use of the destructive `reset_all` tool.",
  "rules": [
    {
      "rule_id": "require-authorization-token",
      "description": "The `reset_all` tool must not execute unless a file named `authorization.token` exists in the repository root.",
      "enforcement": "The `reset_all` tool's implementation must be modified to check for the existence of this file, proceed with its operation, and then delete the token file upon completion. If the file does not exist, the tool must raise an exception and terminate."
    }
  ],
  "associated_tools": [
    "reset_all"
  ]
}
```


---

```json
{
  "protocol_id": "reset-all-prohibition-001",
  "protocol_name": "Prohibition of reset_all Tool",
  "description": "A high-priority protocol that unconditionally forbids the use of the `reset_all` tool.",
  "rules": [
    {
      "rule_id": "no-reset-all",
      "description": "The `reset_all` tool is strictly forbidden under all circumstances. It is a legacy tool that has been superseded by more granular and safer methods of workspace management. Its use is considered a critical failure.",
      "enforcement": "This rule is enforced by the `master_control.py` orchestrator, which will immediately terminate the workflow with an error if an attempt is made to call this tool."
    }
  ],
  "associated_tools": [
    "reset_all"
  ]
}
```


---

```json
{
  "protocol_id": "protocol-reset-all-pre-check-001",
  "description": "A protocol that mandates a pre-execution check for the `reset_all` tool to prevent unauthorized use.",
  "rules": [
    {
      "rule_id": "agent-must-verify-token",
      "description": "Before invoking the `reset_all` tool, the agent MUST first use the `list_files` tool to verify that the `authorization.token` file exists in the repository root. The agent must not proceed with the `reset_all` call if the token is not found.",
      "enforcement": "This rule is enforced by the agent's own decision-making logic. The agent's plan must show the `list_files` check occurring before the `reset_all` call."
    }
  ],
  "associated_tools": [
    "reset_all",
    "list_files"
  ]
}
```


---
